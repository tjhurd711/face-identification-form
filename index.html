<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition - Birth Years</title>
    <link rel="icon" type="image/svg+xml" href="https://www.dropbox.com/scl/fi/7tqrvmnchu17tkatqa9l5/MemorialVideoAI-Favicon.svg?rlkey=5cj4gwyhq3frrupo1g1d3y8so&st=znzwkpy9&raw=1">
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
          font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
          min-height: 100vh;
          padding: 20px;
          color: #333;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .form-card {
            background: #d0a789;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 600;
        }
        .subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 40px;
            font-size: 16px;
        }
        .notice-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 40px;
        }
        .notice-box h2 {
            color: #856404;
            margin: 0 0 8px 0;
            font-size: 18px;
            font-weight: 600;
        }
        .notice-box p {
            color: #856404;
            margin: 0;
            font-size: 14px;
        }
        .face-container {
            margin-bottom: 40px;
            padding: 30px;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        .face-container:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .face-label {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        .input-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .input-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
        .input-card-title {
            font-size: 13px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .checkbox-label, .radio-label {
            display: flex;
            align-items: flex-start;
            font-size: 14px;
            line-height: 1.5;
            color: #495057;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .checkbox-label input[type="checkbox"],
        .radio-label input[type="radio"] {
            margin-right: 10px;
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        .deceased-indicator {
            background: #fee2e2;
            border: 1px solid #fecaca;
        }
        .birth-year-section {
            margin-top: 30px;
            text-align: center;
        }
        .birth-year-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 16px;
        }
        .birth-year-input {
            width: 150px;
            padding: 12px 16px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .birth-year-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .birth-year-input:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .submit-btn {
            background: #3b82f6;
            color: white;
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 40px auto 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .submit-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .error {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 500;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .thank-you-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }
        .thank-you-content {
            background: white;
            max-width: 600px;
            margin: 80px auto;
            padding: 50px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        .thank-you-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 40px;
            color: white;
        }
        .thank-you-title {
            font-size: 32px;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .thank-you-message {
            font-size: 18px;
            color: #6c757d;
            line-height: 1.7;
            margin-bottom: 30px;
        }
        .thank-you-footer {
            font-size: 14px;
            color: #adb5bd;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        .image-overlay {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin: 0 auto;
        }
        .image-overlay img {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: block;
            margin: 0 auto;
        }
        .face-box {
            position: absolute;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        .modal-content {
            position: relative;
            margin: auto;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .modal img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 36px;
            font-weight: 300;
            cursor: pointer;
            z-index: 1001;
            transition: opacity 0.2s ease;
        }
        .close:hover {
            opacity: 0.7;
        }
        .click-hint {
            font-size: 12px;
            color: #adb5bd;
            margin-top: 8px;
            text-align: center;
        }
        .deceased-reminder {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
            border-radius: 8px;
            padding: 20px;
            margin: 30px auto;
            max-width: 600px;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
        }
        .submit-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            color: #991b1b;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        .image-wrapper {
            text-align: center;
        }
        @media (max-width: 768px) {
            .form-card {
                padding: 30px 20px;
            }
            .input-section {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 26px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-card">
            <h1>MemorialVideo.AI - Family Photo Face Recognition</h1>
            <p class="subtitle">Help us identify and sort your family photos by age</p>
            
            <div class="notice-box">
                <h2>Important Notice</h2>
                <p>If the same person is shown in the form twice, that's perfectly normal. Just fill in the same birth year again.</p>
            </div>
            
            <div id="faces-container">
                <div class="loading">Loading faces...</div>
            </div>

            <!-- Reminder when deceased person is not checked -->
            <div id="deceased-reminder" class="deceased-reminder" style="display: none;">
                Remember to check the <strong>"Check this box if this is the person who has passed"</strong> on the person who has passed
            </div>

            <button class="submit-btn" onclick="submitForm()">Submit</button>
            
            <!-- Error message for submit without deceased selection -->
            <div id="submit-error" class="submit-error" style="display: none;">
                Please mark which person has passed before submitting
            </div>
            
            <div id="result"></div>
        </div>
    </div>

    <!-- Modal for enlarged images -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImg" src="">
        </div>
    </div>

    <!-- Thank you overlay that appears after successful submission -->
    <div id="thankYouOverlay" class="thank-you-overlay">
        <div class="thank-you-content">
            <div class="thank-you-icon">✓</div>
            <h1 class="thank-you-title">Thank You!</h1>
            <p class="thank-you-message">
                Thank you for providing this useful information - it will improve the accuracy of your aged sorted photos. 
                <br><br>
                Please keep an eye on your inbox for when the photos and/or slides are ready - should be within 25-35 more minutes.
            </p>
            <div class="thank-you-footer">
                Your form has been successfully submitted. You may close this window.
            </div>
        </div>
    </div>

    <script>
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        const value = results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        return value;
    }

    function handleUnsureChange(faceIndex) {
        const unsureCheckbox = document.getElementById(`face${faceIndex}_unsure`);
        const birthYearInput = document.getElementById(`face${faceIndex}_year`);
        const errorDiv = document.getElementById(`face${faceIndex}_error`);
        
        if (unsureCheckbox.checked) {
            birthYearInput.disabled = true;
            birthYearInput.value = '';
            errorDiv.textContent = '';
        } else {
            birthYearInput.disabled = false;
        }
    }

    // Validation functions
    function validateDeceasedBirthYears() {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        const deceasedFaces = [];
        const deceasedBirthYears = [];
        
        // Collect all deceased faces and their birth years
        for (let i = 1; i <= faceCount; i++) {
            const deceasedCheckbox = document.getElementById(`face${i}_deceased`);
            const birthYearInput = document.getElementById(`face${i}_year`);
            const unsureCheckbox = document.getElementById(`face${i}_unsure`);
            
            if (deceasedCheckbox && deceasedCheckbox.checked) {
                deceasedFaces.push(i);
                
                // Only check birth year if not marked as unsure
                if (!unsureCheckbox.checked && birthYearInput && birthYearInput.value) {
                    const birthYear = parseInt(birthYearInput.value);
                    if (birthYear >= 1900 && birthYear <= 2026) {
                        deceasedBirthYears.push({
                            faceIndex: i,
                            birthYear: birthYear
                        });
                    }
                }
            }
        }
        
        // Check for conflicts only if we have multiple deceased faces with birth years
        if (deceasedFaces.length > 1 && deceasedBirthYears.length > 1) {
            const uniqueBirthYears = [...new Set(deceasedBirthYears.map(item => item.birthYear))];
            
            if (uniqueBirthYears.length > 1) {
                // Conflict detected!
                const conflictMessage = deceasedBirthYears.map(item => 
                    `Person ${item.faceIndex}: ${item.birthYear}`
                ).join('\n');
                
                alert(`⚠️ Birth Year Conflict Detected!\n\nYou marked multiple people as deceased but gave them different birth years:\n\n${conflictMessage}\n\nSince these represent the same person at different ages, they should have the same birth year. Please correct this before submitting.`);
                
                // Highlight the conflicting inputs
                deceasedBirthYears.forEach(item => {
                    const input = document.getElementById(`face${item.faceIndex}_year`);
                    if (input) {
                        input.style.border = '3px solid red';
                        input.style.backgroundColor = '#ffe6e6';
                    }
                });
                
                return false; // Prevent submission
            }
        }
        
        // Clear any previous conflict highlighting
        for (let i = 1; i <= faceCount; i++) {
            const input = document.getElementById(`face${i}_year`);
            if (input) {
                input.style.border = '';
                input.style.backgroundColor = '';
            }
        }
        
        return true; // Validation passed
    }

    function setupDeceasedValidation() {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        
        for (let i = 1; i <= faceCount; i++) {
            const deceasedCheckbox = document.getElementById(`face${i}_deceased`);
            const birthYearInput = document.getElementById(`face${i}_year`);
            
            if (deceasedCheckbox) {
                deceasedCheckbox.addEventListener('change', () => {
                    setTimeout(validateDeceasedBirthYears, 100);
                });
            }
            
            if (birthYearInput) {
                birthYearInput.addEventListener('input', () => {
                    setTimeout(validateDeceasedBirthYears, 100);
                });
            }
        }
    }

    function syncDeceasedBirthYears(changedFaceIndex) {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        const changedInput = document.getElementById(`face${changedFaceIndex}_year`);
        const changedCheckbox = document.getElementById(`face${changedFaceIndex}_deceased`);
        const changedUnsure = document.getElementById(`face${changedFaceIndex}_unsure`);
        
        // Only sync if this face is deceased, not unsure, and has a valid birth year
        if (!changedCheckbox.checked || changedUnsure.checked || !changedInput.value) {
            return;
        }
        
        const newBirthYear = parseInt(changedInput.value);
        if (newBirthYear < 1900 || newBirthYear > 2026) {
            return;
        }
        
        // Find all other deceased faces and update their birth years
        let syncedCount = 0;
        for (let i = 1; i <= faceCount; i++) {
            if (i === changedFaceIndex) continue;
            
            const otherCheckbox = document.getElementById(`face${i}_deceased`);
            const otherInput = document.getElementById(`face${i}_year`);
            const otherUnsure = document.getElementById(`face${i}_unsure`);
            
            if (otherCheckbox && otherCheckbox.checked && !otherUnsure.checked) {
                const currentValue = parseInt(otherInput.value) || 0;
                
                // Only update if it's empty or different
                if (!otherInput.value || currentValue !== newBirthYear) {
                    otherInput.value = newBirthYear;
                    otherInput.style.border = '2px solid green';
                    otherInput.style.backgroundColor = '#e6ffe6';
                    syncedCount++;
                    
                    // Clear the highlighting after a moment
                    setTimeout(() => {
                        otherInput.style.border = '';
                        otherInput.style.backgroundColor = '';
                    }, 2000);
                }
            }
        }
        
        if (syncedCount > 0) {
            // Show a brief confirmation
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 1000;
                font-weight: bold;
            `;
            message.textContent = `✓ Synced birth year to ${syncedCount} other deceased face(s)`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                document.body.removeChild(message);
            }, 3000);
        }
    }

    function setupBirthYearSync() {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        
        for (let i = 1; i <= faceCount; i++) {
            const birthYearInput = document.getElementById(`face${i}_year`);
            
            if (birthYearInput) {
                birthYearInput.addEventListener('blur', () => {
                    syncDeceasedBirthYears(i);
                });
            }
        }
    }

    function showDirectImage(imageUrl, bbox, faceIndex, roll) {
        return new Promise((resolve) => {
            const img = new Image();
            
            img.onload = function() {
                // Calculate face box position
                const imgWidth = 300; // Display width
                const imgHeight = (img.naturalHeight / img.naturalWidth) * imgWidth;
                
                // Images are already properly oriented by Lambda's ImageOps.exif_transpose()
                // No CSS rotation needed - just use bbox coordinates directly
                const faceBox = {
                    left: bbox.left * imgWidth,
                    top: bbox.top * imgHeight,
                    width: bbox.width * imgWidth,
                    height: bbox.height * imgHeight
                };
                
                console.log(`Face ${faceIndex}: Using pre-corrected image, bbox=`, faceBox);
                
                const imageHtml = `
                    <div class="image-wrapper">
                        <div class="image-overlay" onclick="openModal('${imageUrl}'); return false;">
                            <img src="${imageUrl}" alt="Full Image ${faceIndex}" 
                                   style="max-width: 300px; height: auto;"
                                   onclick="openModal('${imageUrl}'); return false;">
                            <div class="face-box" style="
                                left: ${faceBox.left}px; 
                                top: ${faceBox.top}px; 
                                width: ${faceBox.width}px; 
                                height: ${faceBox.height}px;
                                pointer-events: none;
                            "></div>
                        </div>
                        <div class="click-hint">
                            Click image to enlarge
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 3px;">
                            Blue box shows detected face area
                        </div>
                    </div>
                `;
                
                resolve(imageHtml);
            };
            
            img.onerror = function() {
                resolve(`<div style="color: red;">Failed to load image</div>`);
            };
            
            img.src = imageUrl;
        });
    }

    // Window load handler
    window.addEventListener('load', function() {
        loadFaces();
        
        // Set up validation after faces are loaded
        setTimeout(() => {
            setupDeceasedValidation();
            setupBirthYearSync();
            updateDeceasedReminder();
        }, 2000);
    });

    async function loadFaces() {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        const orderId = getUrlParameter('order_id') || '';
        
        if (faceCount === 0) {
            document.getElementById('faces-container').innerHTML = 
                '<div style="text-align: center; color: #999;">No faces provided. This appears to be a demo page.</div>';
            return;
        }
        
        let facesHtml = '';
        
        for (let i = 1; i <= faceCount; i++) {
            facesHtml += `
                <div class="face-container" id="face-container-${i}">
                    <div class="face-label">Person ${i}</div>
                    <div class="loading">Loading face image...</div>
                </div>
            `;
        }
        
        document.getElementById('faces-container').innerHTML = facesHtml;
        
        // Load faces one by one
        for (let i = 1; i <= faceCount; i++) {
            const faceUrl = getUrlParameter('face' + i + '_url');
            const left = parseFloat(getUrlParameter('face' + i + '_left')) || 0;
            const top = parseFloat(getUrlParameter('face' + i + '_top')) || 0;
            const width = parseFloat(getUrlParameter('face' + i + '_width')) || 1;
            const height = parseFloat(getUrlParameter('face' + i + '_height')) || 1;
            const roll = parseFloat(getUrlParameter('face' + i + '_roll')) || 0;
            
            if (faceUrl) {
                const bbox = { left, top, width, height };
                
                try {
                    const imageHtml = await showDirectImage(faceUrl, bbox, i, roll);
                    const container = document.getElementById('face-container-' + i);
                    
                    container.innerHTML = `
                        <div class="face-label">Familiar Face ${i}</div>
                        ${imageHtml}
                        
                        <div class="input-section">
                            <div class="input-card">
                                <div class="input-card-title">Deceased Person</div>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="face${i}_deceased" onchange="updateDeceasedReminder()">
                                    This is the person who has passed
                                </label>
                            </div>
                            
                            <div class="input-card">
                                <div class="input-card-title">Skin Tone</div>
                                <label class="radio-label">
                                    <input type="radio" name="face${i}_skin_tone" value="light" checked>
                                    Light skin (Caucasian)
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="face${i}_skin_tone" value="dark">
                                    Medium/Darker skin
                                </label>
                            </div>
                            
                            <div class="input-card">
                                <div class="input-card-title">Birth Year</div>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="face${i}_unsure" onchange="handleUnsureChange(${i})">
                                    I'm not sure of the birth year
                                </label>
                            </div>
                        </div>
                        
                        <div class="birth-year-section">
                            <label>Enter Birth Year (at least within 3 years):</label>
                            <input type="number" class="birth-year-input" 
                                    id="face${i}_year" 
                                    min="1900" max="2026" 
                                    placeholder="e.g. 1985">
                            <div class="error" id="face${i}_error"></div>
                        </div>
                    `;
                    
                } catch (error) {
                    const container = document.getElementById('face-container-' + i);
                    container.innerHTML = `
                        <div class="face-label">Face ${i}</div>
                        <div style="color: red; padding: 10px;">
                            Error loading face image
                        </div>
                    `;
                }
            } else {
                const container = document.getElementById('face-container-' + i);
                container.innerHTML = `
                    <div class="face-label">Face ${i}</div>
                    <div style="color: red; padding: 10px;">
                        No image URL provided for this face
                    </div>
                `;
            }
        }
        
        // Initialize the deceased reminder visibility after loading
        setTimeout(() => {
            updateDeceasedReminder();
        }, 1000);
    }

    function updateDeceasedReminder() {
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        let anyDeceasedChecked = false;

        // Check if any deceased checkbox is checked
        for (let i = 1; i <= faceCount; i++) {
            const deceasedCheckbox = document.getElementById(`face${i}_deceased`);
            if (deceasedCheckbox && deceasedCheckbox.checked) {
                anyDeceasedChecked = true;
                break;
            }
        }

        // Show reminder only if no deceased boxes are checked
        const reminder = document.getElementById('deceased-reminder');
        if (reminder) {
            reminder.style.display = anyDeceasedChecked ? 'none' : 'block';
        }

        // Hide submit error when a deceased checkbox is checked
        if (anyDeceasedChecked) {
            const submitError = document.getElementById('submit-error');
            if (submitError) {
                submitError.style.display = 'none';
            }
        }
    }

    function openModal(imageUrl) {
        try {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            if (modal && modalImg) {
                modal.style.display = 'block';
                modalImg.src = imageUrl;
            }
        } catch (error) {
            console.error('Error opening modal:', error);
        }
    }

    function closeModal() {
        try {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.style.display = 'none';
            }
        } catch (error) {
            console.error('Error closing modal:', error);
        }
    }

    async function submitForm() {
        // Validate deceased birth years first
        if (!validateDeceasedBirthYears()) {
            return; // Stop submission if validation fails
        }
        
        // Clear previous errors
        document.querySelectorAll('.error').forEach(el => el.textContent = '');
        const submitError = document.getElementById('submit-error');
        submitError.style.display = 'none';
        
        const faceCount = parseInt(getUrlParameter('face_count')) || 0;
        const orderId = getUrlParameter('order_id') || '';
        
        const birthYears = {};
        const deceasedFaces = [];
        const unsureFaces = [];
        const skinTones = {};
        let hasErrors = false;
        
        for (let i = 1; i <= faceCount; i++) {
            const yearInput = document.getElementById('face' + i + '_year');
            const deceasedCheckbox = document.getElementById('face' + i + '_deceased');
            const unsureCheckbox = document.getElementById('face' + i + '_unsure');
            const skinToneRadio = document.querySelector(`input[name="face${i}_skin_tone"]:checked`);
            const error = document.getElementById('face' + i + '_error');
        
            if (yearInput && deceasedCheckbox && unsureCheckbox && error) {
                if (deceasedCheckbox.checked) {
                    deceasedFaces.push(`person_${i}`);
                }
                
                // Collect skin tone selection
                if (skinToneRadio) {
                    skinTones[`person_${i}`] = skinToneRadio.value; // "light" or "dark"
                }
        
                if (unsureCheckbox.checked) {
                    unsureFaces.push(`person_${i}`);
                } else {
                    const year = parseInt(yearInput.value);
                    if (!year || year < 1900 || year > 2026) {
                        error.textContent = 'Please enter a valid birth year (1900-2026) or check "unsure"';
                        hasErrors = true;
                    } else {
                        birthYears[`person_${i}`] = year;
                    }
                }
            }
        }
        
        // Check if no deceased person was marked
        if (deceasedFaces.length === 0) {
            submitError.style.display = 'block';
            return;
        }
        
        // Confirm if multiple deceased faces marked
        if (deceasedFaces.length > 1) {
            if (!confirm(`You marked ${deceasedFaces.length} faces as the deceased person. This likely means the same person appears in multiple age ranges. We'll merge these together. Continue?`)) {
                return;
            }
        }
        
        if (hasErrors) {
            return;
        }
        
        const submissionData = {
            order_id: orderId,
            birth_years: birthYears,
            deceased_faces: deceasedFaces,
            unsure_faces: unsureFaces,
            skin_tones: skinTones,
            submitted_at: new Date().toISOString(),
            face_count: faceCount
        };

        submitToS3(submissionData);
    }

    async function submitToS3(data) {
        document.getElementById('result').innerHTML = '<div class="loading">Submitting your responses...</div>';
        
        try {
            const orderId = data.order_id;
        
            // Upload form data to existing location  
            const formDataKey = `ff-analysis/${orderId}/form_submission.json`;
            const formDataUrl = `https://order-by-age-uploads.s3.amazonaws.com/${formDataKey}`;
        
            await fetch(formDataUrl, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-amz-acl': 'bucket-owner-full-control'
                },
                body: JSON.stringify(data)
            });
        
            // Create completion flag in new trigger location
            const completionKey = `form-handler/${orderId}/form.complete`;
            const completionUrl = `https://order-by-age-uploads.s3.amazonaws.com/${completionKey}`;
        
            await fetch(completionUrl, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-amz-acl': 'bucket-owner-full-control'
                },
                body: JSON.stringify({
                    completed_at: new Date().toISOString(),
                    deceased_person_identified: data.deceased_faces.length > 0
                })
            });
        
            // Show thank you overlay instead of inline message
            document.getElementById('thankYouOverlay').style.display = 'block';
            
            // Disable the submit button to prevent double submission
            const submitBtn = document.querySelector('.submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
            }
            
            // Hide the main form content to prevent any interaction
            document.querySelector('.container').style.display = 'none';
        
        } catch (error) {
            document.getElementById('result').innerHTML = `
                <div style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                    <h3>Submission Error</h3>
                    <p>Please try again. Error: ${error.message}</p>
                </div>
            `;
        }
    }
    </script>
</body>
</html>
